function copy(){function e(e){for(;e.length>0&&!s;)l=e.pop(),a=(new Date).getTime(),s=a-y>=v,m="application/vnd.google-apps.folder"==l.mimeType?t(l):r(l),n.permissions&&("application/vnd.google-apps.document"==l.mimeType||"application/vnd.google-apps.folder"==l.mimeType||"application/vnd.google-apps.spreadsheet"==l.mimeType||"application/vnd.google-apps.presentation"==l.mimeType||"application/vnd.google-apps.drawing"==l.mimeType||"application/vnd.google-apps.form"==l.mimeType||"application/vnd.google-apps.script"==l.mimeType)&&(Logger.log("item type = "+l.mimeType),Logger.log("copying permissions"),i(l.id,l.owners,m.id)),m.id?p.getRange(p.getLastRow()+1,1,1,5).setValues([["Copied",m.title,'=HYPERLINK("https://drive.google.com/open?id='+m.id+'","'+m.title+'")',m.id,Utilities.formatDate(new Date,f,"MM-dd-yy hh:mm:ss aaa")]]):p.getRange(p.getLastRow()+1,1,1,5).setValues([["Error, "+m,l.title,'=HYPERLINK("https://drive.google.com/open?id='+l.id+'","'+l.title+'")',l.id,Utilities.formatDate(new Date,f,"MM-dd-yy hh:mm:ss aaa")]])}function t(e){try{var t=Drive.Files.insert({description:e.description,title:e.title,parents:[{kind:"drive#fileLink",id:n.map[e.parents[0].id]}],mimeType:"application/vnd.google-apps.folder"});return n.remaining.push(e.id),n.map[e.id]=t.id,t}catch(r){return Logger.log(r.message),r}}function r(e){try{var t=Drive.Files.copy({title:e.title,parents:[{kind:"drive#fileLink",id:n.map[e.parents[0].id]}]},e.id);return t}catch(r){return Logger.log(r.message),r}}function i(e,t,r){Logger.log("src id: "+e+" & dest id: "+r);var i,o=getPermissions(e),s=o.items;if(s&&s.length>0)for(i=0;i<s.length;i++)if(s[i].emailAddress){if("owner"==s[i].role)continue;Drive.Permissions.insert({role:s[i].role,type:s[i].type,value:s[i].emailAddress},r,{sendNotificationEmails:"false"})}else Drive.Permissions.insert({role:s[i].role,type:s[i].type,id:s[i].id,withLink:s[i].withLink},r,{sendNotificationEmails:"false"});if(t&&t.length>0)for(i=0;i<t.length;i++)Drive.Permissions.insert({role:"writer",type:"user",value:t[i].emailAddress},r,{sendNotificationEmails:"false"})}function o(){void 0!==n.triggerId&&deleteTrigger(n.triggerId),n.leftovers=d&&d.items?d:n.leftovers,n.pageToken=n.leftovers.nextPageToken,saveProperties(n,createTrigger)}var s,a,p,n,g,d,l,c,m,f,v=318e3,y=(new Date).getTime();for(n=loadProperties(),Logger.log("properties loaded"),p=SpreadsheetApp.openById(n.spreadsheetId).getSheetByName("Log"),f=SpreadsheetApp.openById(n.spreadsheetId).getSpreadsheetTimeZone(),n.leftovers.items&&n.leftovers.items.length>0&&(Logger.log("beginning processFiles on leftovers"),n.destFolder=n.leftovers.items[0].parents[0].id,e(n.leftovers.items)),Logger.log("beginning processFiles on next remaining folder");n.remaining.length>0&&!s;){c=n.pageToken?n.destFolder:n.remaining.shift(),g='"'+c+'" in parents and trashed = false';do d=getFiles(g,n.pageToken),d.items&&d.items.length>0?e(d.items):Logger.log("No children found."),n.pageToken=d.nextPageToken;while(n.pageToken&&!s)}s?(p.getRange(p.getLastRow()+1,1,1,1).setValue("Paused due to Google quota limits - copy will resume in 1-2 minutes"),o()):(void 0!==n.triggerId&&deleteTrigger(n.triggerId),Drive.Files.update({labels:{trashed:!0}},n.propertiesDocId),p.getRange(2,3,1,1).setValue("Complete").setBackground("#66b22c"),p.getRange(2,4,1,1).setValue(Utilities.formatDate(new Date,f,"MM-dd-yy hh:mm:ss a")))}function saveProperties(e,t){var r=PropertiesService.getUserProperties().getProperties(),i=DocumentApp.openById(r.propertiesDocId).getBody(),o={};if(""!==i.getText())try{o=JSON.parse(i.getText())}catch(s){Logger.log("propsCell error: "+s)}for(var a in e)if(e.hasOwnProperty(a)){if("object"==typeof e[a])try{e[a]=JSON.stringify(e[a])}catch(s){Logger.log("propertiesToSave error: key = "+a+", "+s)}o[a]=e[a]}try{i.setText(JSON.stringify(o))}catch(s){Logger.log("setValue error: "+s)}t&&t(),Logger.log("properties saved")}function loadProperties(){var e,t,r;e=PropertiesService.getUserProperties().getProperties(),r=DocumentApp.openById(e.propertiesDocId).getBody(),t=JSON.parse(r.getText());try{t.map=JSON.parse(t.map),Logger.log("JSON.parse properties.map")}catch(i){Logger.log(i.message)}try{t.leftovers=JSON.parse(t.leftovers),Logger.log("JSON.parse properties.leftovers")}catch(i){Logger.log(i.message)}try{t.remaining=JSON.parse(t.remaining),Logger.log("JSON.parse properties.remaining")}catch(i){Logger.log(i.message)}return t}function createTrigger(){var e=ScriptApp.newTrigger("copy").timeBased().after(121e3).create();Logger.log("trigger created, copy resuming in 121 seconds"),saveProperties({triggerId:e.getUniqueId()},null)}function deleteTrigger(e){for(var t=ScriptApp.getProjectTriggers(),r=0;r<t.length;r++)if(t[r].getUniqueId()==e){ScriptApp.deleteTrigger(t[r]);break}}function getOAuthToken(){return ScriptApp.getOAuthToken()}function getMetadata(e){return Drive.Files.get(e)}function getPermissions(e){return Drive.Permissions.list(e)}function getFiles(e,t){var r;return r=Drive.Files.list({q:e,maxResults:1e3,pageToken:t})}function doGet(e){var t=HtmlService.createTemplateFromFile("Index");return t.thisForm=e.parameter.thisForm,t.evaluate().setTitle("Copy a Google Drive folder").setSandboxMode(HtmlService.SandboxMode.IFRAME)}function initialize(e){var t,r,i,o,s=Utilities.formatDate(new Date,"GMT-5","MM-dd-yyyy");try{t=Drive.Files.insert({description:"Copy of "+e.srcName+", created "+s,title:e.destName,parents:[{kind:"drive#fileLink",id:"same"==e.destLocation?e.srcParentId:DriveApp.getRootFolder().getId()}],mimeType:"application/vnd.google-apps.folder"})}catch(a){Logger.log(a.message)}try{r=Drive.Files.copy({title:"Copy Folder Log "+s,parents:[{kind:"drive#fileLink",id:t.id}]},"17xHN9N5KxVie9nuFFzCur7WkcMP7aLG4xsPis8Ctxjg")}catch(a){Logger.log(a.message)}try{i=Drive.Files.insert({description:"This document will be deleted after the folder copy is complete.  It is only used to store properties necessary to complete the copying procedure",title:"DO NOT DELETE OR MODIFY - will be deleted after copying completes",parents:[{kind:"drive#fileLink",id:t.id}],mimeType:"application/vnd.google-apps.document"})}catch(a){Logger.log(a.message)}return SpreadsheetApp.openById(r.id).getSheetByName("Log").getRange(2,5).setValue('=HYPERLINK("https://drive.google.com/open?id='+t.id+'","'+e.destName+'")'),e.destId=t.id,e.spreadsheetId=r.id,e.propertiesDocId=i.id,e.leftovers={},e.map={},e.map[e.srcId]=e.destId,e.remaining=[e.srcId],o=PropertiesService.getUserProperties(),o.setProperty("spreadsheetId",e.spreadsheetId),o.setProperty("propertiesDocId",e.propertiesDocId),saveProperties(e,null),{spreadsheetId:e.spreadsheetId,destId:e.destId}}