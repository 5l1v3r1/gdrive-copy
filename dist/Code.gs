function copy(){function e(e){for(;e.length>0&&!i;)l=e.pop(),s=(new Date).getTime(),i=s-f>=c,g=t(l),g.id?log(o,["Copied",g.title,'=HYPERLINK("https://drive.google.com/open?id='+g.id+'","'+g.title+'")',g.id,Utilities.formatDate(new Date,m,"MM-dd-yy hh:mm:ss aaa")]):log(o,["Error, "+g,l.title,'=HYPERLINK("https://drive.google.com/open?id='+l.id+'","'+l.title+'")',l.id,Utilities.formatDate(new Date,m,"MM-dd-yy hh:mm:ss aaa")]),a.permissions&&("application/vnd.google-apps.document"==l.mimeType||"application/vnd.google-apps.folder"==l.mimeType||"application/vnd.google-apps.spreadsheet"==l.mimeType||"application/vnd.google-apps.presentation"==l.mimeType||"application/vnd.google-apps.drawing"==l.mimeType||"application/vnd.google-apps.form"==l.mimeType||"application/vnd.google-apps.script"==l.mimeType)&&copyPermissions(l.id,l.owners,g.id)}function t(e){if("application/vnd.google-apps.folder"==l.mimeType)try{var t=Drive.Files.insert({description:e.description,title:e.title,parents:[{kind:"drive#fileLink",id:a.map[e.parents[0].id]}],mimeType:"application/vnd.google-apps.folder"});return a.remaining.push(e.id),a.map[e.id]=t.id,t}catch(r){return log(o,[r.message,r.fileName,r.lineNumber]),r}else try{return Drive.Files.copy({title:e.title,parents:[{kind:"drive#fileLink",id:a.map[e.parents[0].id]}]},e.id)}catch(r){return log(o,[r.message,r.fileName,r.lineNumber]),r}}function r(){try{a.leftovers=p&&p.items?p:a.leftovers,a.pageToken=a.leftovers.nextPageToken}catch(e){log(o,[e.message,e.fileName,e.lineNumber])}try{saveProperties(a),exponentialBackoff(createTrigger,"Error setting trigger.  There has been a server error with Google Apps Script.To successfully finish copying, please Copy Folder.")}catch(e){log(o,[e.message,e.fileName,e.lineNumber])}}var i,s,o,a,n,p,l,d,g,m,c=306e3,f=(new Date).getTime();try{a=exponentialBackoff(loadProperties,"Error restarting script, will retry in 1-2 minutes")}catch(h){var y=Number(PropertiesService.getUserProperties().getProperties().trials);return Logger.log(y),void(5>y&&(Logger.log("setting trials property"),PropertiesService.getUserProperties().setProperty("trials",(y+1).toString()),exponentialBackoff(createTrigger,'Error setting trigger.  There has been a server error with Google Apps Script.To successfully finish copying, please refresh the app and click "Resume Copying"and follow the instructions on the page.')))}if(o=SpreadsheetApp.openById(a.spreadsheetId).getSheetByName("Log"),m=SpreadsheetApp.openById(a.spreadsheetId).getSpreadsheetTimeZone()||"GMT-7",void 0!==a.triggerId)try{deleteTrigger(a.triggerId)}catch(h){log(o,[h.message,h.fileName,h.lineNumber,Utilities.formatDate(new Date,m,"MM-dd-yy hh:mm:ss aaa")])}for(a.leftovers.items&&a.leftovers.items.length>0&&(a.destFolder=a.leftovers.items[0].parents[0].id,e(a.leftovers.items)),Logger.log("beginning processFiles on next remaining folder");a.remaining.length>0&&!i;){try{d=a.pageToken?a.destFolder:a.remaining.shift()}catch(h){log(o,[h.message,h.fileName,h.lineNumber,Utilities.formatDate(new Date,m,"MM-dd-yy hh:mm:ss aaa")])}n='"'+d+'" in parents and trashed = false';do{try{p=getFiles(n,a.pageToken)}catch(h){log(o,[h.message,h.fileName,h.lineNumber])}p.items&&p.items.length>0?e(p.items):Logger.log("No children found."),a.pageToken=p.nextPageToken}while(a.pageToken&&!i)}if(i)log(o,["Paused due to Google quota limits - copy will resume in 1-2 minutes"]),r();else{try{Drive.Files.update({labels:{trashed:!0}},a.propertiesDocId)}catch(h){log(o,[h.message,h.fileName,h.lineNumber])}o.getRange(2,3,1,1).setValue("Complete").setBackground("#66b22c"),o.getRange(2,4,1,1).setValue(Utilities.formatDate(new Date,m,"MM-dd-yy hh:mm:ss a"))}}function copyPermissions(e,t,r){var i,s,o,a;try{i=getPermissions(e).items}catch(n){log(null,[n.message,n.fileName,n.lineNumber])}if(i&&i.length>0)for(o=0;o<i.length;o++)try{if(i[o].emailAddress){if("owner"==i[o].role)continue;Drive.Permissions.insert({role:i[o].role,type:i[o].type,value:i[o].emailAddress},r,{sendNotificationEmails:"false"})}else Drive.Permissions.insert({role:i[o].role,type:i[o].type,id:i[o].id,withLink:i[o].withLink},r,{sendNotificationEmails:"false"})}catch(n){}if(t&&t.length>0)for(o=0;o<t.length;o++)try{Drive.Permissions.insert({role:"writer",type:"user",value:t[o].emailAddress},r,{sendNotificationEmails:"false"})}catch(n){}try{s=getPermissions(r).items}catch(n){log(null,[n.message,n.fileName,n.lineNumber])}if(s&&s.length>0)for(o=0;o<s.length;o++)for(a=0;a<i.length&&s[o].id!=i[a].id;a++)a==i.length-1&&"owner"!=s[o].role&&Drive.Permissions.remove(r,s[o].id)}function findPriorCopy(e){var t="'"+e+"' in parents and title contains 'DO NOT DELETE OR MODIFY' and mimeType = 'application/vnd.google-apps.document'",r=Drive.Files.list({q:t,maxResults:1e3,orderBy:"modifiedDate,createdDate"});t="'"+e+"' in parents and title contains 'Copy Folder Log' and mimeType = 'application/vnd.google-apps.spreadsheet'";var i=Drive.Files.list({q:t,maxResults:1e3,orderBy:"title desc"});return{spreadsheetId:i.items[0].id,propertiesDocId:r.items[0].id}}function getOAuthToken(){return ScriptApp.getOAuthToken()}function getMetadata(e){return Drive.Files.get(e)}function getPermissions(e){return Drive.Permissions.list(e)}function getFiles(e,t){var r;return r=Drive.Files.list({q:e,maxResults:1e3,pageToken:t})}function log(e,t){return null==e&&(e=SpreadsheetApp.openById(PropertiesService.getUserProperties().getProperties().spreadsheetId).getSheetByName("Log")),e.getRange(e.getLastRow()+1,1,1,t.length).setValues([t])}function exponentialBackoff(e,t){for(var r=0;6>r;r++)try{return e()}catch(i){if(log(null,[i.message,i.fileName,i.lineNumber]),5==r)throw log(null,[t,"","","",Utilities.formatDate(new Date,"GMT-7","MM-dd-yy hh:mm:ss aaa")]),i;Utilities.sleep(1e3*Math.pow(2,r)+Math.round(1e3*Math.random()))}}function doGet(e){var t=HtmlService.createTemplateFromFile("Index");return t.thisForm=e.parameter.thisForm,t.evaluate().setTitle("Copy a Google Drive folder").setSandboxMode(HtmlService.SandboxMode.IFRAME)}function initialize(e){var t,r,i,s,o=Utilities.formatDate(new Date,"GMT-5","MM-dd-yyyy");try{t=Drive.Files.insert({description:"Copy of "+e.srcName+", created "+o,title:e.destName,parents:[{kind:"drive#fileLink",id:"same"==e.destLocation?e.srcParentId:DriveApp.getRootFolder().getId()}],mimeType:"application/vnd.google-apps.folder"})}catch(a){Logger.log(a.message)}try{r=Drive.Files.copy({title:"Copy Folder Log "+o,parents:[{kind:"drive#fileLink",id:t.id}]},"17xHN9N5KxVie9nuFFzCur7WkcMP7aLG4xsPis8Ctxjg")}catch(a){Logger.log(a.message)}try{i=Drive.Files.insert({description:"This document will be deleted after the folder copy is complete.  It is only used to store properties necessary to complete the copying procedure",title:"DO NOT DELETE OR MODIFY - will be deleted after copying completes",parents:[{kind:"drive#fileLink",id:t.id}],mimeType:"application/vnd.google-apps.document"})}catch(a){Logger.log(a.message)}return e.permissions&&copyPermissions(e.srcId,null,t.id),SpreadsheetApp.openById(r.id).getSheetByName("Log").getRange(2,5).setValue('=HYPERLINK("https://drive.google.com/open?id='+t.id+'","'+e.destName+'")'),e.destId=t.id,e.spreadsheetId=r.id,e.propertiesDocId=i.id,e.leftovers={},e.map={},e.map[e.srcId]=e.destId,e.remaining=[e.srcId],s=PropertiesService.getUserProperties(),s.setProperty("spreadsheetId",e.spreadsheetId),s.setProperty("propertiesDocId",e.propertiesDocId),s.setProperty("trials",0),s.setProperty("resuming","false"),saveProperties(e),{spreadsheetId:e.spreadsheetId,destId:e.destId,resuming:!1}}function loadProperties(){var e,t,r;try{e=PropertiesService.getUserProperties().getProperties(),r=DocumentApp.openById(e.propertiesDocId).getBody(),t=JSON.parse(r.getText())}catch(i){throw i}try{t.map=JSON.parse(t.map),t.leftovers=JSON.parse(t.leftovers),t.remaining=JSON.parse(t.remaining),t.permissions=JSON.parse(t.permissions)}catch(i){throw i}return t}function resume(e){var t=findPriorCopy(e.srcId);return PropertiesService.getUserProperties().setProperty("destId",e.destId),PropertiesService.getUserProperties().setProperty("resuming","true"),PropertiesService.getUserProperties().setProperty("spreadsheetId",t.spreadsheetId),PropertiesService.getUserProperties().setProperty("propertiesDocId",t.propertiesDocId),Logger.log(t.propertiesDocId),{spreadsheetId:t.spreadsheetId,destId:e.srcId,resuming:!0}}function saveProperties(e){var t,r,i,s;try{t=PropertiesService.getUserProperties().getProperties(),r=DocumentApp.openById(t.propertiesDocId).getBody(),i={},s=SpreadsheetApp.openById(t.spreadsheetId).getSheetByName("Log")}catch(o){log(null,[o.message,o.fileName,o.lineNumber])}if(""!==r.getText())try{i=JSON.parse(r.getText())}catch(o){log(s,[o.message,o.fileName,o.lineNumber,Utilities.formatDate(new Date,timeZone,"MM-dd-yy hh:mm:ss aaa")])}for(var a in e)e.hasOwnProperty(a)&&("string"!=typeof e[a]?i[a]=JSON.stringify(e[a]):i[a]=e[a],Logger.log("key: "+a+", value: "+i[a]));try{r.setText(JSON.stringify(i))}catch(o){log(s,[o.message,o.fileName,o.lineNumber,Utilities.formatDate(new Date,timeZone,"MM-dd-yy hh:mm:ss aaa")])}}function getTriggersQuantity(){return ScriptApp.getProjectTriggers().length}function createTrigger(){var e=ScriptApp.newTrigger("copy").timeBased().after(121e3).create();e&&saveProperties({triggerId:e.getUniqueId()})}function deleteTrigger(e){try{for(var t=ScriptApp.getProjectTriggers(),r=0;r<t.length;r++)if(t[r].getUniqueId()==e){ScriptApp.deleteTrigger(t[r]);break}}catch(i){log(ss,[i.message,i.fileName,i.lineNumber])}}function deleteAllTriggers(){for(var e=ScriptApp.getProjectTriggers(),t=0;t<e.length;t++)ScriptApp.deleteTrigger(e[t])}