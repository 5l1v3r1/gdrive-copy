function copy(){function e(e){for(;p.items.length>0&&!a;)l=p.items.pop(),s=(new Date).getTime(),a=s-h>=u,m="application/vnd.google-apps.folder"==l.mimeType?r(l):t(l),m.id?n.getRange(n.getLastRow()+1,1,1,5).setValues([["Copied",m.title,'=HYPERLINK("https://drive.google.com/open?id='+m.id+'","'+m.title+'")',m.id,Utilities.formatDate(new Date,"GMT-7","MM-dd-yy hh:mm:ss a")]]):n.getRange(n.getLastRow()+1,1,1,5).setValues([["Error, "+m+" "+m.message,l.title,'=HYPERLINK("https://drive.google.com/open?id='+l.id+'","'+l.title+'")',l.id,Utilities.formatDate(new Date,"GMT-7","MM-dd-yy hh:mm:ss a")]])}function r(e){try{var r=Drive.Files.insert({description:e.description,title:e.title,parents:[{kind:"drive#fileLink",id:g.map[e.parents[0].id]}],mimeType:"application/vnd.google-apps.folder"});return g.remaining.push(e.id),g.map[e.id]=r.id,r}catch(t){return g.errorFiles.push(e),Logger.log(t.message),t}}function t(e){try{var r=Drive.Files.copy({title:e.title,parents:[{kind:"drive#fileLink",id:g.map[e.parents[0].id]}]},e.id);return r}catch(t){return g.errorFiles.push(e),Logger.log(t.message),t}}function i(e){var r;return r=Drive.Files.list({q:e,maxResults:1e3,pageToken:g.pageToken})}function o(){void 0!==g.triggerId&&deleteTrigger(g.triggerId),g.currChildren=p.items?p:g.currChildren,saveProperties(g,createTrigger)}var a,s,n,g,d,p,l,c,m,u=342e3,h=(new Date).getTime(),a=!1;for(g=loadProperties(),n=SpreadsheetApp.openById(g.spreadsheetId).getSheetByName("Log"),g.currChildren.items&&g.currChildren.items.length>0&&e(g.currChildren.items);g.remaining.length>0&&!a;){c=g.remaining.shift(),d='"'+c+'" in parents and trashed = false';do p=i(d),p.items&&p.items.length>0?e(p.items):Logger.log("No children found."),g.pageToken=p.nextPageToken;while(g.pageToken&&!a)}g.errorFiles.length>0&&!a&&e(g.errorFiles),a?o():(deleteTrigger(g.triggerId),n.getRange(2,3,1,1).setValue("Complete").setBackground("#66b22c"),n.getRange(2,4,1,1).setValue(Utilities.formatDate(new Date,"GMT-5","MM-dd-yy hh:mm:ss a")))}function saveProperties(e,r){var t=PropertiesService.getUserProperties();for(var i in e)e.hasOwnProperty(i)&&"object"==typeof e[i]&&(e[i]=JSON.stringify(e[i]));t.setProperties(e),r&&r()}function loadProperties(){var e,r;e=PropertiesService.getUserProperties(),r=e.getProperties();try{r.map=JSON.parse(r.map),Logger.log("JSON.parse properties.map")}catch(t){Logger.log(t.message)}try{r.currChildren=JSON.parse(r.currChildren),Logger.log("JSON.parse properties.currChildren")}catch(t){Logger.log(t.message)}try{r.remaining=JSON.parse(r.remaining),Logger.log("JSON.parse properties.remaining")}catch(t){Logger.log(t.message)}return r}function createTrigger(){var e=ScriptApp.newTrigger("copy").timeBased().after(61e3).create();saveProperties({triggerId:e.getUniqueId()},null)}function deleteTrigger(e){for(var r=ScriptApp.getProjectTriggers(),t=0;t<r.length;t++)if(r[t].getUniqueId()==e){ScriptApp.deleteTrigger(r[t]);break}}function getOAuthToken(){return ScriptApp.getOAuthToken()}function getMetadata(e){return Drive.Files.get(e)}function doGet(e){var r=HtmlService.createTemplateFromFile("Index");return r.thisForm=e.parameter.thisForm,r.evaluate().setTitle("Copy a Google Drive folder").setSandboxMode(HtmlService.SandboxMode.IFRAME)}function initialize(e){var r,t,i={},o=Utilities.formatDate(new Date,"GMT-5","MM-dd-yyyy");try{r=Drive.Files.insert({description:"Copy of "+e.srcName+", created "+o,title:e.destName,parents:[{kind:"drive#fileLink",id:"same"==e.destLocation?e.srcParentId:DriveApp.getRootFolder().getId()}],mimeType:"application/vnd.google-apps.folder"})}catch(a){Logger.log(a.message)}try{t=Drive.Files.copy({title:"Copy Folder Log "+o,parents:[{kind:"drive#fileLink",id:r.id}]},"17xHN9N5KxVie9nuFFzCur7WkcMP7aLG4xsPis8Ctxjg")}catch(a){Logger.log(a.message)}return SpreadsheetApp.openById(t.id).getSheetByName("Log").getRange(2,5).setValue('=HYPERLINK("https://drive.google.com/open?id='+r.id+'","'+e.destName+'")'),e.destId=r.id,e.spreadsheetId=t.id,i[e.srcId]=e.destId,e.map=i,e.remaining=[e.srcId],e.errorFiles=[],e.currChildren={},saveProperties(e,null),{spreadsheetId:e.spreadsheetId,destId:e.destId}}